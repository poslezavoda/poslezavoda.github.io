<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watermark App для Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .header p {
            color: #aaa;
            font-size: 16px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-title {
            font-size: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: #00c6ff;
        }

        .upload-area {
            border: 2px dashed rgba(0, 114, 255, 0.5);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #0072ff;
            background: rgba(0, 114, 255, 0.05);
        }

        .upload-icon {
            font-size: 48px;
            color: #0072ff;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #aaa;
            font-size: 14px;
        }

        .preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        .preview-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #aaa;
        }

        #mediaPreview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        #videoPreview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        label {
            font-size: 16px;
            font-weight: 500;
            color: #ddd;
        }

        select, input[type="text"], input[type="range"] {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            color: white;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }

        select:focus, input[type="text"]:focus {
            border-color: #0072ff;
            box-shadow: 0 0 0 2px rgba(0, 114, 255, 0.3);
        }

        input[type="range"] {
            padding: 8px 0;
        }

        .range-value {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #aaa;
        }

        .watermark-type {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .type-option {
            flex: 1;
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .type-option.active {
            background: rgba(0, 114, 255, 0.2);
            border-color: #0072ff;
        }

        .position-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .position-btn {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .position-btn.active {
            background: rgba(0, 114, 255, 0.2);
            border-color: #0072ff;
        }

        .position-btn i {
            font-size: 20px;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #0072ff;
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(90deg, #0072ff, #00c6ff);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 114, 255, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top-color: #0072ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .processing-text {
            font-size: 20px;
            color: white;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: #aaa;
            font-size: 14px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hidden {
            display: none;
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 16px;
            }
            
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-water"></i> Watermark App</h1>
            <p>Наложение водяных знаков на фото и видео без потери качества</p>
        </div>

        <div class="card">
            <h2 class="card-title"><i class="fas fa-upload"></i> Загрузите медиа</h2>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">Нажмите для загрузки фото или видео</div>
                <div class="upload-subtext">Поддерживаются форматы: JPG, PNG, GIF, MP4, WEBM</div>
                <input type="file" id="fileInput" accept="image/*,video/*" class="hidden">
            </div>

            <div class="preview-container">
                <div class="preview-title">Предпросмотр:</div>
                <img id="mediaPreview" class="hidden">
                <video id="videoPreview" class="hidden" controls></video>
                <div id="noPreview" class="preview-title">Медиафайл не загружен</div>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title"><i class="fas fa-tint"></i> Настройки водяного знака</h2>
            
            <div class="controls">
                <div class="control-group">
                    <label>Тип водяного знака:</label>
                    <div class="watermark-type">
                        <div class="type-option active" id="textTypeOption">
                            <i class="fas fa-font"></i> Текст
                        </div>
                        <div class="type-option" id="imageTypeOption">
                            <i class="fas fa-image"></i> Изображение
                        </div>
                    </div>
                </div>

                <div class="control-group" id="textWatermarkControl">
                    <label for="watermarkText">Текст водяного знака:</label>
                    <input type="text" id="watermarkText" placeholder="Введите текст водяного знака" value="Watermark">
                </div>

                <div class="control-group hidden" id="imageWatermarkControl">
                    <label>Загрузите изображение водяного знака:</label>
                    <div class="upload-area" id="watermarkUploadArea" style="padding: 20px;">
                        <div class="upload-icon" style="font-size: 32px;">
                            <i class="fas fa-file-image"></i>
                        </div>
                        <div class="upload-text" style="font-size: 14px;">Загрузить изображение</div>
                        <input type="file" id="watermarkImageInput" accept="image/*" class="hidden">
                    </div>
                    <img id="watermarkImagePreview" class="hidden" style="max-width: 100px; max-height: 100px; margin-top: 10px; border-radius: 5px;">
                </div>

                <div class="control-group">
                    <label for="opacitySlider">Прозрачность: <span id="opacityValue">70%</span></label>
                    <input type="range" id="opacitySlider" min="10" max="100" value="70">
                    <div class="range-value">
                        <span>Меньше</span>
                        <span>Больше</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Позиция водяного знака:</label>
                    <div class="position-grid">
                        <div class="position-btn active" data-position="top-left">
                            <i class="fas fa-arrow-up-left"></i>
                        </div>
                        <div class="position-btn" data-position="top-center">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                        <div class="position-btn" data-position="top-right">
                            <i class="fas fa-arrow-up-right"></i>
                        </div>
                        <div class="position-btn" data-position="center-left">
                            <i class="fas fa-arrow-left"></i>
                        </div>
                        <div class="position-btn" data-position="center">
                            <i class="fas fa-circle"></i>
                        </div>
                        <div class="position-btn" data-position="center-right">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                        <div class="position-btn" data-position="bottom-left">
                            <i class="fas fa-arrow-down-left"></i>
                        </div>
                        <div class="position-btn" data-position="bottom-center">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                        <div class="position-btn" data-position="bottom-right">
                            <i class="fas fa-arrow-down-right"></i>
                        </div>
                    </div>
                </div>

                <div class="control-group" id="videoOptions">
                    <label>Опции для видео:</label>
                    <div class="toggle-switch">
                        <span>Подвижная водяная марка (плавает по видео)</span>
                        <label class="switch">
                            <input type="checkbox" id="movingWatermark">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn btn-secondary" id="resetBtn">
                <i class="fas fa-redo"></i> Сбросить
            </button>
            <button class="btn btn-primary" id="applyBtn" disabled>
                <i class="fas fa-magic"></i> Применить водяной знак
            </button>
            <button class="btn btn-primary" id="downloadBtn" disabled>
                <i class="fas fa-download"></i> Скачать результат
            </button>
        </div>

        <div class="footer">
            <p>Вся обработка происходит на вашем устройстве. Качество и FPS видео не урезаются.</p>
            <p style="margin-top: 10px;">Для работы с Telegram: добавьте этот код в мини-приложение через BotFather</p>
        </div>
    </div>

    <div class="processing-overlay" id="processingOverlay">
        <div class="spinner"></div>
        <div class="processing-text" id="processingText">Обработка...</div>
    </div>

    <script>
        // Инициализация Telegram Web App
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        // Элементы DOM
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const mediaPreview = document.getElementById('mediaPreview');
        const videoPreview = document.getElementById('videoPreview');
        const noPreview = document.getElementById('noPreview');
        const watermarkText = document.getElementById('watermarkText');
        const watermarkImageInput = document.getElementById('watermarkImageInput');
        const watermarkUploadArea = document.getElementById('watermarkUploadArea');
        const watermarkImagePreview = document.getElementById('watermarkImagePreview');
        const opacitySlider = document.getElementById('opacitySlider');
        const opacityValue = document.getElementById('opacityValue');
        const positionButtons = document.querySelectorAll('.position-btn');
        const movingWatermark = document.getElementById('movingWatermark');
        const applyBtn = document.getElementById('applyBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const processingOverlay = document.getElementById('processingOverlay');
        const processingText = document.getElementById('processingText');
        const textTypeOption = document.getElementById('textTypeOption');
        const imageTypeOption = document.getElementById('imageTypeOption');
        const textWatermarkControl = document.getElementById('textWatermarkControl');
        const imageWatermarkControl = document.getElementById('imageWatermarkControl');
        
        // Переменные состояния
        let originalMedia = null;
        let processedMedia = null;
        let watermarkType = 'text'; // 'text' или 'image'
        let watermarkImage = null;
        let position = 'bottom-right';
        let isVideo = false;
        let videoFrames = [];
        let videoDuration = 0;
        
        // Инициализация
        init();
        
        function init() {
            // События для загрузки основного медиа
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleMediaUpload);
            
            // События для переключения типа водяного знака
            textTypeOption.addEventListener('click', () => setWatermarkType('text'));
            imageTypeOption.addEventListener('click', () => setWatermarkType('image'));
            
            // События для загрузки изображения водяного знака
            watermarkUploadArea.addEventListener('click', () => watermarkImageInput.click());
            watermarkImageInput.addEventListener('change', handleWatermarkImageUpload);
            
            // События для слайдера прозрачности
            opacitySlider.addEventListener('input', () => {
                opacityValue.textContent = `${opacitySlider.value}%`;
            });
            
            // События для кнопок позиционирования
            positionButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    positionButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    position = btn.dataset.position;
                });
            });
            
            // События для кнопок действий
            applyBtn.addEventListener('click', applyWatermark);
            downloadBtn.addEventListener('click', downloadResult);
            resetBtn.addEventListener('click', resetApp);
        }
        
        function setWatermarkType(type) {
            watermarkType = type;
            
            if (type === 'text') {
                textTypeOption.classList.add('active');
                imageTypeOption.classList.remove('active');
                textWatermarkControl.classList.remove('hidden');
                imageWatermarkControl.classList.add('hidden');
            } else {
                textTypeOption.classList.remove('active');
                imageTypeOption.classList.add('active');
                textWatermarkControl.classList.add('hidden');
                imageWatermarkControl.classList.remove('hidden');
            }
        }
        
        function handleMediaUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileType = file.type;
            const reader = new FileReader();
            
            reader.onload = function(e) {
                originalMedia = {
                    file: file,
                    url: e.target.result,
                    type: fileType
                };
                
                // Определяем, является ли файл видео
                isVideo = fileType.startsWith('video/');
                
                // Показываем предпросмотр
                if (isVideo) {
                    mediaPreview.classList.add('hidden');
                    videoPreview.classList.remove('hidden');
                    noPreview.classList.add('hidden');
                    
                    videoPreview.src = e.target.result;
                    videoPreview.load();
                    
                    // Получаем длительность видео после загрузки метаданных
                    videoPreview.onloadedmetadata = function() {
                        videoDuration = videoPreview.duration;
                    };
                    
                    // Показываем опции для видео
                    document.getElementById('videoOptions').classList.remove('hidden');
                } else {
                    videoPreview.classList.add('hidden');
                    mediaPreview.classList.remove('hidden');
                    noPreview.classList.add('hidden');
                    
                    mediaPreview.src = e.target.result;
                    
                    // Скрываем опции для видео
                    document.getElementById('videoOptions').classList.add('hidden');
                }
                
                // Активируем кнопку применения
                applyBtn.disabled = false;
            };
            
            reader.readAsDataURL(file);
        }
        
        function handleWatermarkImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                watermarkImage = new Image();
                watermarkImage.src = e.target.result;
                
                watermarkImagePreview.src = e.target.result;
                watermarkImagePreview.classList.remove('hidden');
            };
            
            reader.readAsDataURL(file);
        }
        
        function applyWatermark() {
            if (!originalMedia) return;
            
            showProcessing('Применение водяного знака...');
            
            if (isVideo) {
                processVideo();
            } else {
                processImage();
            }
        }
        
        function processImage() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Устанавливаем размеры canvas равными размерам изображения
                canvas.width = img.width;
                canvas.height = img.height;
                
                // Рисуем исходное изображение
                ctx.drawImage(img, 0, 0);
                
                // Применяем водяной знак
                applyWatermarkToCanvas(ctx, canvas.width, canvas.height);
                
                // Получаем обработанное изображение
                processedMedia = canvas.toDataURL(originalMedia.type || 'image/png');
                
                // Показываем результат
                mediaPreview.src = processedMedia;
                
                // Активируем кнопку скачивания
                downloadBtn.disabled = false;
                
                hideProcessing();
            };
            
            img.src = originalMedia.url;
        }
        
        function processVideo() {
            showProcessing('Обработка видео... Это может занять некоторое время');
            
            // Создаем временное видео для извлечения кадров
            const tempVideo = document.createElement('video');
            tempVideo.src = originalMedia.url;
            tempVideo.muted = true;
            tempVideo.crossOrigin = 'anonymous';
            
            tempVideo.onloadeddata = function() {
                // Создаем canvas для обработки
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = tempVideo.videoWidth;
                canvas.height = tempVideo.videoHeight;
                
                const fps = 30; // Сохраняем оригинальный FPS
                const totalFrames = Math.floor(videoDuration * fps);
                let currentFrame = 0;
                
                // Функция для обработки каждого кадра
                function processFrame() {
                    // Устанавливаем текущее время видео для нужного кадра
                    tempVideo.currentTime = currentFrame / fps;
                    
                    // Ждем, пока видео обновится
                    tempVideo.onseeked = function() {
                        // Очищаем canvas
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        
                        // Рисуем текущий кадр
                        ctx.drawImage(tempVideo, 0, 0, canvas.width, canvas.height);
                        
                        // Применяем водяной знак
                        applyWatermarkToCanvas(ctx, canvas.width, canvas.height, currentFrame, totalFrames);
                        
                        // Сохраняем кадр
                        videoFrames.push(canvas.toDataURL('image/jpeg', 1.0));
                        
                        // Переходим к следующему кадру
                        currentFrame++;
                        
                        // Обновляем текст процесса
                        processingText.textContent = `Обработка видео... ${Math.round((currentFrame / totalFrames) * 100)}%`;
                        
                        if (currentFrame < totalFrames) {
                            // Обрабатываем следующий кадр
                            setTimeout(processFrame, 0);
                        } else {
                            // Все кадры обработаны, создаем видео
                            createVideoFromFrames(fps);
                        }
                    };
                }
                
                // Начинаем обработку
                processFrame();
            };
            
            tempVideo.load();
        }
        
        function createVideoFromFrames(fps) {
            showProcessing('Создание видео...');
            
            // Используем MediaRecorder для создания видео из кадров
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Устанавливаем размеры canvas
            canvas.width = videoPreview.videoWidth;
            canvas.height = videoPreview.videoHeight;
            
            // Создаем поток с canvas
            const stream = canvas.captureStream(fps);
            const mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'video/webm;codecs=vp9',
                videoBitsPerSecond: 2500000 // Высокое качество
            });
            
            const chunks = [];
            
            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0) {
                    chunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = function() {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                processedMedia = url;
                
                // Показываем результат
                videoPreview.src = url;
                
                // Активируем кнопку скачивания
                downloadBtn.disabled = false;
                
                hideProcessing();
            };
            
            // Начинаем запись
            mediaRecorder.start();
            
            // Воспроизводим кадры
            let frameIndex = 0;
            const totalFrames = videoFrames.length;
            
            function drawNextFrame() {
                if (frameIndex >= totalFrames) {
                    mediaRecorder.stop();
                    return;
                }
                
                const img = new Image();
                img.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    frameIndex++;
                    setTimeout(drawNextFrame, 1000 / fps);
                };
                
                img.src = videoFrames[frameIndex];
            }
            
            drawNextFrame();
        }
        
        function applyWatermarkToCanvas(ctx, width, height, frameIndex = 0, totalFrames = 1) {
            const opacity = parseInt(opacitySlider.value) / 100;
            
            // Если включена подвижная водяная марка для видео
            let currentPosition = position;
            if (isVideo && movingWatermark.checked && totalFrames > 1) {
                // Меняем позицию в зависимости от номера кадра
                const positions = ['top-left', 'top-center', 'top-right', 
                                  'center-left', 'center', 'center-right',
                                  'bottom-left', 'bottom-center', 'bottom-right'];
                const posIndex = Math.floor((frameIndex / totalFrames) * positions.length) % positions.length;
                currentPosition = positions[posIndex];
            }
            
            // Устанавливаем прозрачность
            ctx.globalAlpha = opacity;
            
            if (watermarkType === 'text' && watermarkText.value.trim()) {
                // Текстовая водяная марка
                const fontSize = Math.min(width, height) * 0.05;
                ctx.font = `bold ${fontSize}px Arial`;
                ctx.fillStyle = 'white';
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 2;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const text = watermarkText.value.trim();
                const textWidth = ctx.measureText(text).width;
                const padding = fontSize * 0.5;
                
                // Вычисляем позицию
                let x, y;
                switch(currentPosition) {
                    case 'top-left':
                        x = textWidth/2 + padding;
                        y = fontSize/2 + padding;
                        ctx.textAlign = 'left';
                        break;
                    case 'top-center':
                        x = width / 2;
                        y = fontSize/2 + padding;
                        break;
                    case 'top-right':
                        x = width - textWidth/2 - padding;
                        y = fontSize/2 + padding;
                        ctx.textAlign = 'right';
                        break;
                    case 'center-left':
                        x = textWidth/2 + padding;
                        y = height / 2;
                        ctx.textAlign = 'left';
                        break;
                    case 'center':
                        x = width / 2;
                        y = height / 2;
                        break;
                    case 'center-right':
                        x = width - textWidth/2 - padding;
                        y = height / 2;
                        ctx.textAlign = 'right';
                        break;
                    case 'bottom-left':
                        x = textWidth/2 + padding;
                        y = height - fontSize/2 - padding;
                        ctx.textAlign = 'left';
                        break;
                    case 'bottom-center':
                        x = width / 2;
                        y = height - fontSize/2 - padding;
                        break;
                    case 'bottom-right':
                        x = width - textWidth/2 - padding;
                        y = height - fontSize/2 - padding;
                        ctx.textAlign = 'right';
                        break;
                }
                
                // Рисуем текст с обводкой
                ctx.strokeText(text, x, y);
                ctx.fillText(text, x, y);
                
            } else if (watermarkType === 'image' && watermarkImage) {
                // Водяная марка из изображения
                const watermarkWidth = width * 0.2;
                const watermarkHeight = (watermarkImage.height / watermarkImage.width) * watermarkWidth;
                
                // Вычисляем позицию
                let x, y;
                switch(currentPosition) {
                    case 'top-left':
                        x = 10;
                        y = 10;
                        break;
                    case 'top-center':
                        x = (width - watermarkWidth) / 2;
                        y = 10;
                        break;
                    case 'top-right':
                        x = width - watermarkWidth - 10;
                        y = 10;
                        break;
                    case 'center-left':
                        x = 10;
                        y = (height - watermarkHeight) / 2;
                        break;
                    case 'center':
                        x = (width - watermarkWidth) / 2;
                        y = (height - watermarkHeight) / 2;
                        break;
                    case 'center-right':
                        x = width - watermarkWidth - 10;
                        y = (height - watermarkHeight) / 2;
                        break;
                    case 'bottom-left':
                        x = 10;
                        y = height - watermarkHeight - 10;
                        break;
                    case 'bottom-center':
                        x = (width - watermarkWidth) / 2;
                        y = height - watermarkHeight - 10;
                        break;
                    case 'bottom-right':
                        x = width - watermarkWidth - 10;
                        y = height - watermarkHeight - 10;
                        break;
                }
                
                // Рисуем изображение водяной марки
                ctx.drawImage(watermarkImage, x, y, watermarkWidth, watermarkHeight);
            }
            
            // Сбрасываем прозрачность
            ctx.globalAlpha = 1.0;
        }
        
        function downloadResult() {
            if (!processedMedia) return;
            
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            
            if (isVideo) {
                link.href = processedMedia;
                link.download = `watermarked-video-${timestamp}.webm`;
            } else {
                link.href = processedMedia;
                link.download = `watermarked-image-${timestamp}.png`;
            }
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Отправляем событие в Telegram
            tg.HapticFeedback.impactOccurred('medium');
        }
        
        function resetApp() {
            // Сброс состояния приложения
            originalMedia = null;
            processedMedia = null;
            watermarkImage = null;
            videoFrames = [];
            
            // Сброс UI
            mediaPreview.classList.add('hidden');
            videoPreview.classList.add('hidden');
            noPreview.classList.remove('hidden');
            
            watermarkImagePreview.classList.add('hidden');
            watermarkImageInput.value = '';
            fileInput.value = '';
            
            applyBtn.disabled = true;
            downloadBtn.disabled = true;
            
            // Сброс настроек
            watermarkText.value = 'Watermark';
            opacitySlider.value = 70;
            opacityValue.textContent = '70%';
            movingWatermark.checked = false;
            
            // Сброс позиции
            positionButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector('.position-btn[data-position="bottom-right"]').classList.add('active');
            position = 'bottom-right';
            
            // Сброс типа водяного знака
            setWatermarkType('text');
            
            tg.HapticFeedback.impactOccurred('light');
        }
        
        function showProcessing(text) {
            processingText.textContent = text;
            processingOverlay.style.display = 'flex';
        }
        
        function hideProcessing() {
            processingOverlay.style.display = 'none';
        }
    </script>
</body>
</html>
