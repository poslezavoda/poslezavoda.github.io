<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TgPosted - –í–æ–¥—è–Ω—ã–µ –∑–Ω–∞–∫–∏ –¥–ª—è Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #0072ff, #00c6ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .steps-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .steps-indicator::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 10%;
            right: 10%;
            height: 3px;
            background: #e0e0e0;
            z-index: 1;
        }

        .step {
            position: relative;
            z-index: 2;
            text-align: center;
            flex: 1;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            margin: 0 auto 10px;
            transition: all 0.3s;
        }

        .step.active .step-circle {
            background: linear-gradient(90deg, #0072ff, #00c6ff);
            color: white;
            transform: scale(1.1);
        }

        .step.completed .step-circle {
            background: #4CAF50;
            color: white;
        }

        .step-text {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .step.active .step-text {
            color: #0072ff;
            font-weight: 600;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }

        .card-title {
            font-size: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
        }

        .card-title i {
            color: #0072ff;
        }

        .step-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .step-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-area {
            border: 2px dashed rgba(0, 114, 255, 0.3);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
            background: #f8f9fa;
        }

        .upload-area:hover {
            border-color: #0072ff;
            background: rgba(0, 114, 255, 0.03);
        }

        .upload-icon {
            font-size: 48px;
            color: #0072ff;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 18px;
            margin-bottom: 10px;
            color: #333;
        }

        .upload-subtext {
            color: #666;
            font-size: 14px;
        }

        .preview-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        .preview-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #666;
            align-self: flex-start;
        }

        #mediaPreview, #processedMediaPreview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            object-fit: contain;
            background-color: #f8f9fa;
        }

        #videoPreview, #processedVideoPreview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            background-color: #000;
            object-fit: contain;
        }

        .video-container {
            width: 100%;
            max-width: 500px;
            position: relative;
            background-color: #000;
            border-radius: 10px;
            overflow: hidden;
            margin: 0 auto;
        }

        .video-container video {
            width: 100%;
            height: auto;
            display: block;
        }

        .change-media-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
        }

        .change-media-btn:hover {
            background: #0072ff;
            color: white;
            transform: scale(1.1);
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        label {
            font-size: 16px;
            font-weight: 500;
            color: #444;
        }

        select, input[type="text"], input[type="range"], input[type="number"] {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 16px;
            color: #333;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }

        select:focus, input[type="text"]:focus, input[type="number"]:focus {
            border-color: #0072ff;
            box-shadow: 0 0 0 2px rgba(0, 114, 255, 0.1);
        }

        input[type="range"] {
            padding: 8px 0;
            background: transparent;
        }

        .range-value {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }

        .watermark-type {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .type-option {
            flex: 1;
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #e0e0e0;
            color: #666;
        }

        .type-option.active {
            background: rgba(0, 114, 255, 0.1);
            border-color: #0072ff;
            color: #0072ff;
        }

        .position-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .position-btn {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #e0e0e0;
            color: #666;
        }

        .position-btn.active {
            background: rgba(0, 114, 255, 0.1);
            border-color: #0072ff;
            color: #0072ff;
        }

        .position-btn i {
            font-size: 20px;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e0e0e0;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #0072ff;
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        .motion-settings {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            display: none;
            border: 1px solid #e0e0e0;
        }

        .motion-settings.active {
            display: block;
        }

        .motion-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            padding: 16px 24px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(90deg, #0072ff, #00c6ff);
            color: white;
            flex: 1;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .btn-success {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            color: white;
            min-width: 250px;
            margin: 0 auto;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 114, 255, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(0, 114, 255, 0.1);
            border-top-color: #0072ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .processing-text {
            font-size: 20px;
            color: #333;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 14px;
            padding-top: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .hidden {
            display: none !important;
        }

        .media-info {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
            text-align: center;
        }

        .result-actions {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .download-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –≤–æ–¥—è–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤ */
        .saved-watermarks {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .saved-watermarks-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .saved-watermarks-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .saved-watermark-item {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 120px;
            text-align: center;
            position: relative;
        }

        .saved-watermark-item:hover {
            border-color: #0072ff;
            transform: translateY(-2px);
        }

        .saved-watermark-item.active {
            border-color: #0072ff;
            background: rgba(0, 114, 255, 0.1);
        }

        .saved-watermark-preview {
            width: 80px;
            height: 40px;
            object-fit: contain;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .saved-watermark-text {
            font-size: 12px;
            color: #333;
            word-break: break-all;
            max-height: 36px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .saved-watermark-actions {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 10px;
        }

        .delete-watermark-btn {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        .save-current-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .save-current-btn:hover {
            background: #e9ecef;
            border-color: #0072ff;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞ */
        .color-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .color-option-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .color-option-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
            color: #444;
        }

        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            padding: 0;
            background: transparent;
        }

        .color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .color-picker::-webkit-color-swatch {
            border: 2px solid #e0e0e0;
            border-radius: 6px;
        }

        .color-value {
            font-size: 14px;
            color: #666;
            min-width: 80px;
        }

        .color-presets {
            display: flex;
            gap: 8px;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .color-preset {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid #e0e0e0;
            transition: all 0.2s;
        }

        .color-preset:hover {
            transform: scale(1.1);
            border-color: #0072ff;
        }

        .color-preset.active {
            border-color: #0072ff;
            transform: scale(1.1);
            box-shadow: 0 0 0 2px rgba(0, 114, 255, 0.2);
        }

        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è */
        .motion-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .motion-presets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .motion-preset {
            padding: 12px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 14px;
        }

        .motion-preset:hover {
            border-color: #0072ff;
            transform: translateY(-2px);
        }

        .motion-preset.active {
            background: rgba(0, 114, 255, 0.1);
            border-color: #0072ff;
            color: #0072ff;
        }

        .motion-preview {
            width: 100%;
            height: 80px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .motion-preview-watermark {
            position: absolute;
            width: 30px;
            height: 30px;
            background: #0072ff;
            border-radius: 4px;
            opacity: 0.7;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ */
        .instruction-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .instruction-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .instruction-title {
            font-size: 22px;
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }

        .instruction-section {
            margin-bottom: 20px;
        }

        .instruction-section h4 {
            color: #0072ff;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .instruction-list {
            padding-left: 20px;
            color: #555;
            font-size: 14px;
            line-height: 1.5;
        }

        .instruction-list li {
            margin-bottom: 8px;
        }

        .instruction-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 12px;
            color: #888;
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 16px;
            }
            
            .motion-controls {
                grid-template-columns: 1fr;
            }
            
            .navigation-buttons {
                flex-direction: column;
            }
            
            .steps-indicator {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .step {
                flex: none;
                width: 30%;
            }
            
            #mediaPreview, #processedMediaPreview, 
            #videoPreview, #processedVideoPreview {
                max-height: 300px;
            }
            
            .btn-success {
                min-width: 200px;
                width: 100%;
                max-width: 300px;
            }
            
            .saved-watermarks-list {
                justify-content: center;
            }
            
            .saved-watermark-item {
                min-width: 100px;
                padding: 8px;
            }
            
            .color-presets {
                justify-content: center;
            }
            
            .motion-presets {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .instruction-content {
                max-width: 90%;
                padding: 16px;
            }
            
            .instruction-list {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-paperclip"></i> TgPosted</h1>
            <p>–ù–∞–ª–æ–∂–µ–Ω–∏–µ –≤–æ–¥—è–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤ –Ω–∞ —Ñ–æ—Ç–æ –∏ –≤–∏–¥–µ–æ –¥–ª—è Telegram</p>
        </div>

        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —à–∞–≥–æ–≤ -->
        <div class="steps-indicator">
            <div class="step active" id="step1">
                <div class="step-circle">1</div>
                <div class="step-text">–°–æ–∑–¥–∞–Ω–∏–µ –≤–æ—Ç–µ—Ä–º–∞—Ä–∫–∏</div>
            </div>
            <div class="step" id="step2">
                <div class="step-circle">2</div>
                <div class="step-text">–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞</div>
            </div>
            <div class="step" id="step3">
                <div class="step-circle">3</div>
                <div class="step-text">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
            </div>
        </div>

        <!-- –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –≤–æ—Ç–µ—Ä–º–∞—Ä–∫–∏ -->
        <div class="card step-content active" id="step1Content">
            <h2 class="card-title"><i class="fas fa-paint-brush"></i> –°–æ–∑–¥–∞–Ω–∏–µ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞</h2>
            
            <!-- –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –≤–æ–¥—è–Ω—ã–µ –∑–Ω–∞–∫–∏ -->
            <div class="saved-watermarks">
                <h3 class="saved-watermarks-title">
                    <i class="fas fa-bookmark"></i> –ú–æ–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –≤–æ–¥—è–Ω—ã–µ –∑–Ω–∞–∫–∏
                </h3>
                <div class="saved-watermarks-list" id="savedWatermarksList">
                    <!-- –ë—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∏–∑ localStorage -->
                </div>
                <div class="save-current-btn" id="saveCurrentWatermarkBtn">
                    <i class="fas fa-save"></i>
                    <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫</span>
                </div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>–¢–∏–ø –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞:</label>
                    <div class="watermark-type">
                        <div class="type-option active" id="textTypeOption">
                            <i class="fas fa-font"></i> –¢–µ–∫—Å—Ç
                        </div>
                        <div class="type-option" id="imageTypeOption">
                            <i class="fas fa-image"></i> –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        </div>
                    </div>
                </div>

                <div class="control-group" id="textWatermarkControl">
                    <label for="watermarkText">–¢–µ–∫—Å—Ç –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞:</label>
                    <input type="text" id="watermarkText" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: @–≤–∞—à_–∫–∞–Ω–∞–ª" value="@TgPosted">
                    
                    <!-- –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞ -->
                    <div class="color-options">
                        <div class="color-option-group">
                            <div class="color-option-label">
                                <span>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞:</span>
                                <span class="color-value" id="textColorValue">#FFFFFF</span>
                            </div>
                            <div class="color-picker-container">
                                <input type="color" id="textColorPicker" class="color-picker" value="#FFFFFF">
                                <div class="color-presets" id="textColorPresets">
                                    <!-- –¶–≤–µ—Ç–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="color-option-group">
                            <div class="color-option-label">
                                <span>–¶–≤–µ—Ç –æ–±–≤–æ–¥–∫–∏:</span>
                                <span class="color-value" id="strokeColorValue">#000000</span>
                            </div>
                            <div class="color-picker-container">
                                <input type="color" id="strokeColorPicker" class="color-picker" value="#000000">
                                <div class="color-presets" id="strokeColorPresets">
                                    <!-- –¶–≤–µ—Ç–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="control-group hidden" id="imageWatermarkControl">
                    <label>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞:</label>
                    <div class="upload-area" id="watermarkUploadArea" style="padding: 20px;">
                        <div class="upload-icon" style="font-size: 32px;">
                            <i class="fas fa-file-image"></i>
                        </div>
                        <div class="upload-text" style="font-size: 14px;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>
                        <input type="file" id="watermarkImageInput" accept="image/*" class="hidden">
                    </div>
                    <img id="watermarkImagePreview" class="hidden" style="max-width: 100px; max-height: 100px; margin-top: 10px; border-radius: 5px;">
                </div>

                <div class="control-group">
                    <label for="opacitySlider">–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å: <span id="opacityValue">70%</span></label>
                    <input type="range" id="opacitySlider" min="10" max="100" value="70">
                    <div class="range-value">
                        <span>–°–ª–∞–±–∞—è</span>
                        <span>–Ø—Ä–∫–∞—è</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>–ü–æ–∑–∏—Ü–∏—è –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞:</label>
                    <div class="position-grid">
                        <div class="position-btn active" data-position="top-left">
                            <i class="fas fa-arrow-up-left"></i>
                        </div>
                        <div class="position-btn" data-position="top-center">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                        <div class="position-btn" data-position="top-right">
                            <i class="fas fa-arrow-up-right"></i>
                        </div>
                        <div class="position-btn" data-position="center-left">
                            <i class="fas fa-arrow-left"></i>
                        </div>
                        <div class="position-btn" data-position="center">
                            <i class="fas fa-circle"></i>
                        </div>
                        <div class="position-btn" data-position="center-right">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                        <div class="position-btn" data-position="bottom-left">
                            <i class="fas fa-arrow-down-left"></i>
                        </div>
                        <div class="position-btn" data-position="bottom-center">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                        <div class="position-btn" data-position="bottom-right">
                            <i class="fas fa-arrow-down-right"></i>
                        </div>
                    </div>
                </div>

                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã) -->
                <div class="control-group motion-options">
                    <label>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è –¥–ª—è –≤–∏–¥–µ–æ:</label>
                    <div class="toggle-switch">
                        <span>–ü–æ–¥–≤–∏–∂–Ω–∞—è –≤–æ–¥—è–Ω–∞—è –º–∞—Ä–∫–∞</span>
                        <label class="switch">
                            <input type="checkbox" id="movingWatermark">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="motion-settings" id="motionSettings">
                        <div class="motion-controls">
                            <div>
                                <label for="speedSlider">–°–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è: <span id="speedValue">5</span></label>
                                <input type="range" id="speedSlider" min="1" max="20" value="5">
                                <div class="range-value">
                                    <span>–ú–µ–¥–ª–µ–Ω–Ω–æ</span>
                                    <span>–ë—ã—Å—Ç—Ä–æ</span>
                                </div>
                            </div>
                            
                            <div>
                                <label for="motionType">–¢–∏–ø –¥–≤–∏–∂–µ–Ω–∏—è:</label>
                                <select id="motionType">
                                    <option value="bounce">–û—Ç—Å–∫–æ–∫ –æ—Ç –∫—Ä–∞–µ–≤</option>
                                    <option value="circular">–ö—Ä—É–≥–æ–≤–æ–µ</option>
                                    <option value="horizontal">–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ</option>
                                    <option value="vertical">–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ</option>
                                    <option value="diagonal">–î–∏–∞–≥–æ–Ω–∞–ª—å–Ω–æ–µ</option>
                                    <option value="spiral">–°–ø–∏—Ä–∞–ª—å–Ω–æ–µ</option>
                                    <option value="random">–°–ª—É—á–∞–π–Ω–æ–µ</option>
                                    <option value="wave">–í–æ–ª–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–µ</option>
                                    <option value="figure8">–í–æ—Å—å–º–µ—Ä–∫–∞</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="motion-presets" id="motionPresets">
                            <!-- –ü—Ä–µ—Å–µ—Ç—ã –¥–≤–∏–∂–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                        </div>
                        
                        <div class="motion-preview" id="motionPreview">
                            <div class="motion-preview-watermark" id="motionPreviewWatermark"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="navigation-buttons">
                <button class="btn btn-secondary" id="resetAllBtn">
                    <i class="fas fa-redo"></i> –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë
                </button>
                <button class="btn btn-primary" id="nextToStep2">
                    –î–∞–ª–µ–µ: –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–¥–∏–∞ <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞ -->
        <div class="card step-content" id="step2Content">
            <h2 class="card-title"><i class="fas fa-upload"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞</h2>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ</div>
                <div class="upload-subtext">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF, MP4, WEBM, MOV</div>
                <input type="file" id="fileInput" accept="image/*,video/*" class="hidden">
            </div>

            <div class="preview-container">
                <div class="preview-title">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –º–µ–¥–∏–∞:</div>
                
                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∏–¥–µ–æ -->
                <div class="video-container hidden" id="videoContainer">
                    <video id="videoPreview" controls></video>
                </div>
                
                <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                <img id="mediaPreview" class="hidden">
                
                <div id="noPreview" class="preview-title" style="text-align: center; width: 100%; padding: 40px 0; color: #999;">
                    <i class="fas fa-image" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                    –ú–µ–¥–∏–∞—Ñ–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
                </div>
                
                <button class="change-media-btn hidden" id="changeMediaBtn" title="–ó–∞–º–µ–Ω–∏—Ç—å –º–µ–¥–∏–∞">
                    <i class="fas fa-exchange-alt"></i>
                </button>
                
                <div id="mediaInfo" class="media-info hidden"></div>
            </div>

            <div class="navigation-buttons">
                <button class="btn btn-secondary" id="backToStep1">
                    <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
                </button>
                <button class="btn btn-primary" id="applyWatermarkBtn" disabled>
                    <i class="fas fa-magic"></i> –ù–∞–ª–æ–∂–∏—Ç—å –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫
                </button>
            </div>
        </div>

        <!-- –®–∞–≥ 3: –†–µ–∑—É–ª—å—Ç–∞—Ç -->
        <div class="card step-content" id="step3Content">
            <h2 class="card-title"><i class="fas fa-check-circle"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
            
            <div class="preview-container">
                <div class="preview-title">–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –º–µ–¥–∏–∞:</div>
                
                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ -->
                <div class="video-container hidden" id="processedVideoContainer">
                    <video id="processedVideoPreview" controls></video>
                </div>
                
                <!-- –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                <img id="processedMediaPreview" class="hidden">
                
                <div id="noProcessedPreview" class="preview-title" style="text-align: center; width: 100%; padding: 40px 0; color: #999;">
                    <i class="fas fa-water" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                    –í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ –µ—â—ë –Ω–µ –Ω–∞–ª–æ–∂–µ–Ω
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="result-actions">
                <div class="download-container">
                    <button class="btn btn-success" id="downloadResultBtn" disabled>
                        <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    </button>
                </div>
                
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-secondary" id="showGalleryInstructionBtn">
                        <i class="fas fa-images"></i> –ö–∞–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –≥–∞–ª–µ—Ä–µ—é?
                    </button>
                </div>
            </div>

            <div class="navigation-buttons">
                <button class="btn btn-secondary" id="backToStep2">
                    <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –∑–∞–≥—Ä—É–∑–∫–µ
                </button>
                <button class="btn btn-primary" id="processNewBtn">
                    <i class="fas fa-plus"></i> –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª
                </button>
            </div>
        </div>

        <div class="footer">
            <p>–í—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ. –ö–∞—á–µ—Å—Ç–≤–æ –∏ FPS –≤–∏–¥–µ–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è.</p>
            <p style="margin-top: 10px;">–î–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram: –¥–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ BotFather</p>
        </div>
    </div>

    <div class="processing-overlay" id="processingOverlay">
        <div class="spinner"></div>
        <div class="processing-text" id="processingText">–û–±—Ä–∞–±–æ—Ç–∫–∞...</div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –≥–∞–ª–µ—Ä–µ—é -->
    <div class="instruction-modal hidden" id="instructionModal">
        <div class="instruction-content">
            <h3 class="instruction-title">üì± –ö–∞–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –≥–∞–ª–µ—Ä–µ—é</h3>
            
            <div class="instruction-section">
                <h4>üì• –°–Ω–∞—á–∞–ª–∞ —Å–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª:</h4>
                <ol class="instruction-list">
                    <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç" –≤—ã—à–µ</li>
                    <li>–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–ø–∫—É "–ó–∞–≥—Ä—É–∑–∫–∏" (Downloads) –≤–∞—à–µ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞</li>
                </ol>
            </div>
            
            <div class="instruction-section">
                <h4>ü§ñ –î–ª—è Android:</h4>
                <ol class="instruction-list">
                    <li>–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ <strong>"–§–∞–π–ª—ã"</strong> –∏–ª–∏ <strong>"–ü—Ä–æ–≤–æ–¥–Ω–∏–∫"</strong></li>
                    <li>–ù–∞–π–¥–∏—Ç–µ –ø–∞–ø–∫—É <strong>"–ó–∞–≥—Ä—É–∑–∫–∏"</strong> (Downloads)</li>
                    <li>–ù–∞–π–¥–∏—Ç–µ —Å–∫–∞—á–∞–Ω–Ω—ã–π —Ñ–∞–π–ª (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å TgPosted_)</li>
                    <li>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ç—Ä–∏ —Ç–æ—á–∫–∏ <strong>"‚ãÆ"</strong> —Ä—è–¥–æ–º —Å —Ñ–∞–π–ª–æ–º</li>
                    <li>–í—ã–±–µ—Ä–∏—Ç–µ <strong>"–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å"</strong> –∏–ª–∏ <strong>"–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å"</strong></li>
                    <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ø–∞–ø–∫—É <strong>"DCIM"</strong> –∏–ª–∏ <strong>"Pictures"</strong></li>
                    <li>–ù–∞–∂–º–∏—Ç–µ <strong>"–í—Å—Ç–∞–≤–∏—Ç—å"</strong> –∏–ª–∏ <strong>"–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Å—é–¥–∞"</strong></li>
                    <li>–¢–µ–ø–µ—Ä—å —Ñ–∞–π–ª –ø–æ—è–≤–∏—Ç—Å—è –≤ –≥–∞–ª–µ—Ä–µ–µ!</li>
                </ol>
            </div>
            
            <div class="instruction-section">
                <h4>üçé –î–ª—è iPhone (iOS):</h4>
                <ol class="instruction-list">
                    <li>–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ <strong>"–§–∞–π–ª—ã"</strong></li>
                    <li>–ù–∞–∂–º–∏—Ç–µ <strong>"–û–±–∑–æ—Ä"</strong> ‚Üí <strong>"–ù–∞ —ç—Ç–æ–º iPhone"</strong></li>
                    <li>–ù–∞–π–¥–∏—Ç–µ –ø–∞–ø–∫—É <strong>"–ó–∞–≥—Ä—É–∑–∫–∏"</strong></li>
                    <li>–ù–∞–π–¥–∏—Ç–µ —Å–∫–∞—á–∞–Ω–Ω—ã–π —Ñ–∞–π–ª (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å TgPosted_)</li>
                    <li>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ñ–∞–π–ª –∏ —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ</li>
                    <li>–í—ã–±–µ—Ä–∏—Ç–µ <strong>"–ü–æ–¥–µ–ª–∏—Ç—å—Å—è"</strong> (–∫–≤–∞–¥—Ä–∞—Ç —Å–æ —Å—Ç—Ä–µ–ª–∫–æ–π)</li>
                    <li>–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –≤–Ω–∏–∑ –∏ –Ω–∞–∂–º–∏—Ç–µ <strong>"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ/–≤–∏–¥–µ–æ"</strong></li>
                    <li>–§–∞–π–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ "–§–æ—Ç–æ"</li>
                </ol>
            </div>
            
            <div class="instruction-section">
                <h4>üí° –ë—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–± (Android):</h4>
                <ol class="instruction-list">
                    <li>–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ <strong>"–ì–∞–ª–µ—Ä–µ—è"</strong> –∏–ª–∏ <strong>"–§–æ—Ç–æ"</strong></li>
                    <li>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ç—Ä–∏ —Ç–æ—á–∫–∏ <strong>"‚ãÆ"</strong> –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É</li>
                    <li>–í—ã–±–µ—Ä–∏—Ç–µ <strong>"–°–∫—Ä—ã—Ç—ã–µ –ø–∞–ø–∫–∏"</strong> –∏–ª–∏ <strong>"–ü–æ–∫–∞–∑–∞—Ç—å —Å–∫—Ä—ã—Ç—ã–µ"</strong></li>
                    <li>–ù–∞–π–¥–∏—Ç–µ –ø–∞–ø–∫—É <strong>"–ó–∞–≥—Ä—É–∑–∫–∏"</strong></li>
                    <li>–ù–∞–π–¥–∏—Ç–µ –≤–∞—à —Ñ–∞–π–ª –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ</li>
                    <li>–ù–∞–∂–º–∏—Ç–µ <strong>"‚ãÆ"</strong> ‚Üí <strong>"–î–æ–±–∞–≤–∏—Ç—å –≤ –∞–ª—å–±–æ–º"</strong></li>
                </ol>
            </div>
            
            <div class="instruction-footer">
                <p>–ü–æ—Å–ª–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –≤ –≥–∞–ª–µ—Ä–µ—é, –≤—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å –µ–≥–æ –∏–∑ –ø–∞–ø–∫–∏ "–ó–∞–≥—Ä—É–∑–∫–∏"</p>
            </div>
            
            <button class="btn btn-primary" id="closeInstructionBtn" style="width: 100%; margin-top: 20px;">
                <i class="fas fa-check"></i> –ü–æ–Ω—è—Ç–Ω–æ, —Å–ø–∞—Å–∏–±–æ!
            </button>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM –¥–ª—è —à–∞–≥–æ–≤
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step1Content = document.getElementById('step1Content');
        const step2Content = document.getElementById('step2Content');
        const step3Content = document.getElementById('step3Content');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        const nextToStep2Btn = document.getElementById('nextToStep2');
        const backToStep1Btn = document.getElementById('backToStep1');
        const backToStep2Btn = document.getElementById('backToStep2');
        const applyWatermarkBtn = document.getElementById('applyWatermarkBtn');
        const processNewBtn = document.getElementById('processNewBtn');
        const resetAllBtn = document.getElementById('resetAllBtn');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ (–∏–∑ –®–∞–≥–∞ 1)
        const watermarkText = document.getElementById('watermarkText');
        const watermarkImageInput = document.getElementById('watermarkImageInput');
        const watermarkUploadArea = document.getElementById('watermarkUploadArea');
        const watermarkImagePreview = document.getElementById('watermarkImagePreview');
        const opacitySlider = document.getElementById('opacitySlider');
        const opacityValue = document.getElementById('opacityValue');
        const positionButtons = document.querySelectorAll('.position-btn');
        const textTypeOption = document.getElementById('textTypeOption');
        const imageTypeOption = document.getElementById('imageTypeOption');
        const textWatermarkControl = document.getElementById('textWatermarkControl');
        const imageWatermarkControl = document.getElementById('imageWatermarkControl');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ü–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞
        const textColorPicker = document.getElementById('textColorPicker');
        const textColorValue = document.getElementById('textColorValue');
        const textColorPresets = document.getElementById('textColorPresets');
        const strokeColorPicker = document.getElementById('strokeColorPicker');
        const strokeColorValue = document.getElementById('strokeColorValue');
        const strokeColorPresets = document.getElementById('strokeColorPresets');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è
        const movingWatermark = document.getElementById('movingWatermark');
        const motionSettings = document.getElementById('motionSettings');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        const motionType = document.getElementById('motionType');
        const motionPresets = document.getElementById('motionPresets');
        const motionPreview = document.getElementById('motionPreview');
        const motionPreviewWatermark = document.getElementById('motionPreviewWatermark');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞ (–∏–∑ –®–∞–≥–∞ 2)
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const mediaPreview = document.getElementById('mediaPreview');
        const videoPreview = document.getElementById('videoPreview');
        const videoContainer = document.getElementById('videoContainer');
        const noPreview = document.getElementById('noPreview');
        const changeMediaBtn = document.getElementById('changeMediaBtn');
        const mediaInfo = document.getElementById('mediaInfo');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–∏–∑ –®–∞–≥–∞ 3)
        const processedMediaPreview = document.getElementById('processedMediaPreview');
        const processedVideoPreview = document.getElementById('processedVideoPreview');
        const processedVideoContainer = document.getElementById('processedVideoContainer');
        const noProcessedPreview = document.getElementById('noProcessedPreview');
        const downloadResultBtn = document.getElementById('downloadResultBtn');
        const showGalleryInstructionBtn = document.getElementById('showGalleryInstructionBtn');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –≤–æ–¥—è–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤
        const savedWatermarksList = document.getElementById('savedWatermarksList');
        const saveCurrentWatermarkBtn = document.getElementById('saveCurrentWatermarkBtn');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
        const instructionModal = document.getElementById('instructionModal');
        const closeInstructionBtn = document.getElementById('closeInstructionBtn');
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        const processingOverlay = document.getElementById('processingOverlay');
        const processingText = document.getElementById('processingText');
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        let currentStep = 1;
        let originalMedia = null;
        let processedMedia = null;
        let watermarkType = 'text';
        let watermarkImage = null;
        let position = 'bottom-right';
        let isVideo = false;
        let videoFrames = [];
        let videoDuration = 0;
        let originalFormat = '';
        let originalFileName = '';
        let savedWatermarks = [];
        
        // –¶–≤–µ—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        let textColor = '#FFFFFF';
        let strokeColor = '#000000';
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è
        let watermarkState = {
            x: 0,
            y: 0,
            width: 0,
            height: 0,
            videoWidth: 0,
            videoHeight: 0,
            speed: 1,
            motionType: 'bounce',
            time: 0,
            amplitude: 100,
            frequency: 0.5,
            pathPoints: []
        };
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–≤–∏–∂–µ–Ω–∏—è
        let motionPreviewAnimation = null;
        let motionPreviewStartTime = 0;
        
        // –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞
        const colorPresets = {
            textColors: [
                '#FFFFFF', '#000000', '#FF0000', '#00FF00', '#0000FF',
                '#FFFF00', '#FF00FF', '#00FFFF', '#FFA500', '#800080',
                '#008000', '#FFC0CB', '#A52A2A', '#808080', '#FFD700'
            ],
            strokeColors: [
                '#000000', '#FFFFFF', '#333333', '#666666', '#999999',
                '#CCCCCC', '#FF0000', '#00FF00', '#0000FF', '#FFA500'
            ]
        };
        
        // –ü—Ä–µ—Å–µ—Ç—ã –¥–≤–∏–∂–µ–Ω–∏—è
        const motionPresetsData = [
            { name: '–ú–µ–¥–ª–µ–Ω–Ω–æ–µ –ø–ª–∞–≤–∞–Ω–∏–µ', speed: 3, type: 'bounce', amplitude: 50, frequency: 0.3 },
            { name: '–ë—ã—Å—Ç—Ä–æ–µ –∫—Ä—É–∂–µ–Ω–∏–µ', speed: 8, type: 'circular', amplitude: 100, frequency: 1 },
            { name: '–ü–ª–∞–≤–Ω–æ–µ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏', speed: 4, type: 'horizontal', amplitude: 80, frequency: 0.4 },
            { name: '–ü–ª–∞–≤–Ω–æ–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏', speed: 4, type: 'vertical', amplitude: 80, frequency: 0.4 },
            { name: '–î–∏–∞–≥–æ–Ω–∞–ª—å–Ω—ã–π –¥—Ä–µ–π—Ñ', speed: 5, type: 'diagonal', amplitude: 70, frequency: 0.5 },
            { name: '–°–ø–∏—Ä–∞–ª—å–Ω—ã–π –ø–æ–ª–µ—Ç', speed: 6, type: 'spiral', amplitude: 120, frequency: 0.8 },
            { name: '–°–ª—É—á–∞–π–Ω—ã–π –ø–∞—Ç—Ä—É–ª—å', speed: 7, type: 'random', amplitude: 90, frequency: 0.6 },
            { name: '–í–æ–ª–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–µ', speed: 5, type: 'wave', amplitude: 60, frequency: 0.7 },
            { name: '–í–æ—Å—å–º–µ—Ä–∫–∞', speed: 6, type: 'figure8', amplitude: 80, frequency: 0.5 }
        ];
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        init();
        
        function init() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –≤–æ–¥—è–Ω—ã–µ –∑–Ω–∞–∫–∏
            loadSavedWatermarks();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—ã–±–æ—Ä —Ü–≤–µ—Ç–∞
            initColorPickers();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–µ—Å–µ—Ç—ã –¥–≤–∏–∂–µ–Ω–∏—è
            initMotionPresets();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–≤–∏–∂–µ–Ω–∏—è
            initMotionPreview();
            
            // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —à–∞–≥–∞–º
            nextToStep2Btn.addEventListener('click', () => goToStep(2));
            backToStep1Btn.addEventListener('click', () => goToStep(1));
            backToStep2Btn.addEventListener('click', () => goToStep(2));
            applyWatermarkBtn.addEventListener('click', applyWatermark);
            processNewBtn.addEventListener('click', () => goToStep(2));
            resetAllBtn.addEventListener('click', resetAll);
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞ (–®–∞–≥ 2)
            uploadArea.addEventListener('click', () => fileInput.click());
            changeMediaBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleMediaUpload);
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ (–®–∞–≥ 1)
            textTypeOption.addEventListener('click', () => setWatermarkType('text'));
            imageTypeOption.addEventListener('click', () => setWatermarkType('image'));
            watermarkUploadArea.addEventListener('click', () => watermarkImageInput.click());
            watermarkImageInput.addEventListener('change', handleWatermarkImageUpload);
            
            opacitySlider.addEventListener('input', () => {
                opacityValue.textContent = `${opacitySlider.value}%`;
            });
            
            positionButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    positionButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    position = btn.dataset.position;
                });
            });
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è
            movingWatermark.addEventListener('change', () => {
                if (movingWatermark.checked) {
                    motionSettings.classList.add('active');
                    startMotionPreview();
                } else {
                    motionSettings.classList.remove('active');
                    stopMotionPreview();
                }
            });
            
            speedSlider.addEventListener('input', () => {
                speedValue.textContent = speedSlider.value;
            });
            
            motionType.addEventListener('change', () => {
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∏–ø–∞ –¥–≤–∏–∂–µ–Ω–∏—è
                if (movingWatermark.checked) {
                    startMotionPreview();
                }
            });
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
            saveCurrentWatermarkBtn.addEventListener('click', saveCurrentWatermark);
            
            // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            downloadResultBtn.addEventListener('click', downloadResult);
            
            // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é –≤ –≥–∞–ª–µ—Ä–µ—é
            showGalleryInstructionBtn.addEventListener('click', showSaveToGalleryInstruction);
            closeInstructionBtn.addEventListener('click', () => {
                instructionModal.classList.add('hidden');
            });
        }
        
        function initColorPickers() {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            textColorPicker.value = textColor;
            strokeColorPicker.value = strokeColor;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            updateColorValues();
            
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ—Å–µ—Ç—ã —Ü–≤–µ—Ç–æ–≤ –¥–ª—è —Ç–µ–∫—Å—Ç–∞
            colorPresets.textColors.forEach(color => {
                const preset = document.createElement('div');
                preset.className = 'color-preset';
                preset.style.backgroundColor = color;
                preset.dataset.color = color;
                preset.title = color;
                
                preset.addEventListener('click', () => {
                    textColorPicker.value = color;
                    textColor = color;
                    updateColorValues();
                    highlightPreset(preset, textColorPresets);
                });
                
                textColorPresets.appendChild(preset);
            });
            
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ—Å–µ—Ç—ã —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –æ–±–≤–æ–¥–∫–∏
            colorPresets.strokeColors.forEach(color => {
                const preset = document.createElement('div');
                preset.className = 'color-preset';
                preset.style.backgroundColor = color;
                preset.dataset.color = color;
                preset.title = color;
                
                preset.addEventListener('click', () => {
                    strokeColorPicker.value = color;
                    strokeColor = color;
                    updateColorValues();
                    highlightPreset(preset, strokeColorPresets);
                });
                
                strokeColorPresets.appendChild(preset);
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ü–≤–µ—Ç–æ–≤—ã—Ö –ø–∏–∫–µ—Ä–æ–≤
            textColorPicker.addEventListener('input', (e) => {
                textColor = e.target.value;
                updateColorValues();
                highlightPresetByColor(textColor, textColorPresets);
            });
            
            strokeColorPicker.addEventListener('input', (e) => {
                strokeColor = e.target.value;
                updateColorValues();
                highlightPresetByColor(strokeColor, strokeColorPresets);
            });
            
            // –í—ã–¥–µ–ª—è–µ–º –ø—Ä–µ—Å–µ—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            highlightPresetByColor(textColor, textColorPresets);
            highlightPresetByColor(strokeColor, strokeColorPresets);
        }
        
        function initMotionPresets() {
            motionPresetsData.forEach((preset, index) => {
                const presetElement = document.createElement('div');
                presetElement.className = 'motion-preset';
                presetElement.dataset.index = index;
                presetElement.textContent = preset.name;
                
                presetElement.addEventListener('click', () => {
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–µ—Å–µ—Ç–∞
                    speedSlider.value = preset.speed;
                    speedValue.textContent = preset.speed;
                    motionType.value = preset.type;
                    
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–¥–≤–∏–∂–Ω—É—é –≤–æ–¥—è–Ω—É—é –º–∞—Ä–∫—É, –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞
                    if (!movingWatermark.checked) {
                        movingWatermark.checked = true;
                        motionSettings.classList.add('active');
                        startMotionPreview();
                    }
                    
                    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–µ—Å–µ—Ç
                    document.querySelectorAll('.motion-preset').forEach(p => {
                        p.classList.remove('active');
                    });
                    presetElement.classList.add('active');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                    startMotionPreview();
                    
                    tg.HapticFeedback.impactOccurred('light');
                });
                
                motionPresets.appendChild(presetElement);
            });
        }
        
        function initMotionPreview() {
            // –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            watermarkState.width = 30;
            watermarkState.height = 30;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ–∫–Ω–∞
            window.addEventListener('resize', () => {
                if (motionPreviewAnimation) {
                    startMotionPreview();
                }
            });
        }
        
        function startMotionPreview() {
            stopMotionPreview(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∞–Ω–∏–º–∞—Ü–∏—é
            
            motionPreviewStartTime = Date.now();
            motionPreviewWatermark.style.width = '30px';
            motionPreviewWatermark.style.height = '30px';
            
            function animate() {
                const currentTime = Date.now();
                const elapsed = (currentTime - motionPreviewStartTime) / 1000; // –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
                
                const previewWidth = motionPreview.clientWidth;
                const previewHeight = motionPreview.clientHeight;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
                const pos = calculateMotionPosition(
                    elapsed,
                    previewWidth,
                    previewHeight,
                    30, // —à–∏—Ä–∏–Ω–∞ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
                    30, // –≤—ã—Å–æ—Ç–∞ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
                    parseInt(speedSlider.value) / 5,
                    motionType.value,
                    100, // –∞–º–ø–ª–∏—Ç—É–¥–∞
                    0.5  // —á–∞—Å—Ç–æ—Ç–∞
                );
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
                motionPreviewWatermark.style.left = `${pos.x}px`;
                motionPreviewWatermark.style.top = `${pos.y}px`;
                
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                motionPreviewAnimation = requestAnimationFrame(animate);
            }
            
            motionPreviewAnimation = requestAnimationFrame(animate);
        }
        
        function calculateMotionPosition(time, width, height, wmWidth, wmHeight, speed, motionType, amplitude, frequency) {
            const maxX = width - wmWidth;
            const maxY = height - wmHeight;
            
            // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –¥–≤–∏–∂–µ–Ω–∏–π
            const t = time * speed;
            
            switch(motionType) {
                case 'bounce':
                    // –ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Å –æ—Ç—Å–∫–æ–∫–∞–º–∏ –æ—Ç –∫—Ä–∞–µ–≤
                    const bounceX = (Math.sin(t * frequency) * 0.5 + 0.5) * maxX;
                    const bounceY = (Math.cos(t * frequency * 0.7) * 0.5 + 0.5) * maxY;
                    return {
                        x: Math.max(0, Math.min(maxX, bounceX)),
                        y: Math.max(0, Math.min(maxY, bounceY))
                    };
                    
                case 'circular':
                    // –ö—Ä—É–≥–æ–≤–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –ø–æ –≤—Å–µ–π –ø–ª–æ—â–∞–¥–∏
                    const centerX = width / 2;
                    const centerY = height / 2;
                    const radius = Math.min(maxX, maxY) * 0.4;
                    const angle = t * frequency;
                    
                    return {
                        x: centerX + Math.cos(angle) * radius - wmWidth / 2,
                        y: centerY + Math.sin(angle) * radius - wmHeight / 2
                    };
                    
                case 'horizontal':
                    // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Ç—É–¥–∞-–æ–±—Ä–∞—Ç–Ω–æ
                    const hProgress = (Math.sin(t * frequency) * 0.5 + 0.5);
                    return {
                        x: hProgress * maxX,
                        y: height / 2 - wmHeight / 2
                    };
                    
                case 'vertical':
                    // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Ç—É–¥–∞-–æ–±—Ä–∞—Ç–Ω–æ
                    const vProgress = (Math.sin(t * frequency) * 0.5 + 0.5);
                    return {
                        x: width / 2 - wmWidth / 2,
                        y: vProgress * maxY
                    };
                    
                case 'diagonal':
                    // –î–∏–∞–≥–æ–Ω–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
                    const diagProgress = (Math.sin(t * frequency) * 0.5 + 0.5);
                    return {
                        x: diagProgress * maxX,
                        y: diagProgress * maxY
                    };
                    
                case 'spiral':
                    // –°–ø–∏—Ä–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –∫ –∫—Ä–∞—è–º
                    const spiralCenterX = width / 2;
                    const spiralCenterY = height / 2;
                    const spiralAngle = t * frequency;
                    const spiralRadius = (t % 10) / 10 * Math.min(maxX, maxY) * 0.5;
                    
                    return {
                        x: spiralCenterX + Math.cos(spiralAngle) * spiralRadius - wmWidth / 2,
                        y: spiralCenterY + Math.sin(spiralAngle) * spiralRadius - wmHeight / 2
                    };
                    
                case 'random':
                    // –ü—Å–µ–≤–¥–æ—Å–ª—É—á–∞–π–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Å –ø–ª–∞–≤–Ω—ã–º–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏
                    const randomX = (Math.sin(t * 0.3) * 0.5 + 0.5) * maxX;
                    const randomY = (Math.cos(t * 0.4) * 0.5 + 0.5) * maxY;
                    return {
                        x: Math.max(0, Math.min(maxX, randomX)),
                        y: Math.max(0, Math.min(maxY, randomY))
                    };
                    
                case 'wave':
                    // –í–æ–ª–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
                    const waveX = (t * 0.5) % maxX;
                    const waveY = Math.sin(t * frequency) * amplitude + height / 2 - wmHeight / 2;
                    
                    return {
                        x: waveX,
                        y: Math.max(0, Math.min(maxY, waveY))
                    };
                    
                case 'figure8':
                    // –î–≤–∏–∂–µ–Ω–∏–µ –ø–æ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –≤–æ—Å—å–º–µ—Ä–∫–∏ (–ª–µ–º–Ω–∏—Å–∫–∞—Ç–∞ –ë–µ—Ä–Ω—É–ª–ª–∏)
                    const scale = Math.min(width, height) * 0.3;
                    const figure8X = Math.sin(t * frequency) * scale + width / 2 - wmWidth / 2;
                    const figure8Y = Math.sin(t * frequency * 2) * scale * 0.5 + height / 2 - wmHeight / 2;
                    
                    return {
                        x: Math.max(0, Math.min(maxX, figure8X)),
                        y: Math.max(0, Math.min(maxY, figure8Y))
                    };
                    
                default:
                    return { x: 0, y: 0 };
            }
        }
        
        function stopMotionPreview() {
            if (motionPreviewAnimation) {
                cancelAnimationFrame(motionPreviewAnimation);
                motionPreviewAnimation = null;
            }
        }
        
        function updateColorValues() {
            textColorValue.textContent = textColor;
            strokeColorValue.textContent = strokeColor;
        }
        
        function highlightPreset(presetElement, container) {
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –ø—Ä–µ—Å–µ—Ç–æ–≤ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
            container.querySelectorAll('.color-preset').forEach(p => {
                p.classList.remove('active');
            });
            
            // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–µ—Å–µ—Ç
            presetElement.classList.add('active');
        }
        
        function highlightPresetByColor(color, container) {
            const presets = container.querySelectorAll('.color-preset');
            let found = false;
            
            presets.forEach(preset => {
                if (preset.dataset.color === color) {
                    preset.classList.add('active');
                    found = true;
                } else {
                    preset.classList.remove('active');
                }
            });
            
            // –ï—Å–ª–∏ —Ü–≤–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω —Å—Ä–µ–¥–∏ –ø—Ä–µ—Å–µ—Ç–æ–≤, —Å–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö
            if (!found) {
                presets.forEach(preset => preset.classList.remove('active'));
            }
        }
        
        function loadSavedWatermarks() {
            const saved = localStorage.getItem('savedWatermarks');
            if (saved) {
                try {
                    savedWatermarks = JSON.parse(saved);
                    renderSavedWatermarksList();
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –≤–æ–¥—è–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤:', e);
                    savedWatermarks = [];
                }
            }
        }
        
        function renderSavedWatermarksList() {
            savedWatermarksList.innerHTML = '';
            
            if (savedWatermarks.length === 0) {
                savedWatermarksList.innerHTML = '<p style="color: #666; text-align: center; width: 100%;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –≤–æ–¥—è–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤</p>';
                return;
            }
            
            savedWatermarks.forEach((watermark, index) => {
                const item = document.createElement('div');
                item.className = 'saved-watermark-item';
                item.dataset.index = index;
                
                if (watermark.type === 'text') {
                    // –î–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –≤–æ–¥—è–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–≤–µ—Ç
                    const colorBox = watermark.textColor ? 
                        `<div style="width: 100%; height: 20px; background-color: ${watermark.textColor}; border-radius: 3px; margin-bottom: 5px;"></div>` : 
                        '';
                    
                    const motionIcon = watermark.motionSettings ? '<i class="fas fa-running" style="color: #0072ff; margin-left: 5px;"></i>' : '';
                    
                    item.innerHTML = `
                        ${colorBox}
                        <div class="saved-watermark-text">${watermark.text} ${motionIcon}</div>
                        <div style="font-size: 10px; color: #666; margin-top: 5px;">${watermark.opacity}%</div>
                        <div class="saved-watermark-actions">
                            <button class="delete-watermark-btn" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                } else {
                    const motionIcon = watermark.motionSettings ? '<i class="fas fa-running" style="color: #0072ff; margin-left: 5px;"></i>' : '';
                    
                    item.innerHTML = `
                        <img src="${watermark.imageData}" class="saved-watermark-preview" alt="Watermark">
                        <div class="saved-watermark-text">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ${motionIcon}</div>
                        <div style="font-size: 10px; color: #666; margin-top: 5px;">${watermark.opacity}%</div>
                        <div class="saved-watermark-actions">
                            <button class="delete-watermark-btn" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                }
                
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-watermark-btn')) {
                        loadSavedWatermark(index);
                    }
                });
                
                const deleteBtn = item.querySelector('.delete-watermark-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteSavedWatermark(index);
                });
                
                savedWatermarksList.appendChild(item);
            });
        }
        
        function loadSavedWatermark(index) {
            const watermark = savedWatermarks[index];
            if (!watermark) return;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–ø –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
            setWatermarkType(watermark.type);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            opacitySlider.value = watermark.opacity;
            opacityValue.textContent = `${watermark.opacity}%`;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é
            positionButtons.forEach(btn => btn.classList.remove('active'));
            const positionBtn = document.querySelector(`.position-btn[data-position="${watermark.position}"]`);
            if (positionBtn) {
                positionBtn.classList.add('active');
                position = watermark.position;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
            if (watermark.type === 'text') {
                watermarkText.value = watermark.text;
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç–∞, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                if (watermark.textColor) {
                    textColor = watermark.textColor;
                    textColorPicker.value = textColor;
                }
                if (watermark.strokeColor) {
                    strokeColor = watermark.strokeColor;
                    strokeColorPicker.value = strokeColor;
                }
                updateColorValues();
                highlightPresetByColor(textColor, textColorPresets);
                highlightPresetByColor(strokeColor, strokeColorPresets);
            } else {
                watermarkImage = new Image();
                watermarkImage.src = watermark.imageData;
                watermarkImage.onload = function() {
                    watermarkImagePreview.src = watermark.imageData;
                    watermarkImagePreview.classList.remove('hidden');
                };
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            if (watermark.motionSettings) {
                movingWatermark.checked = true;
                motionSettings.classList.add('active');
                speedSlider.value = watermark.motionSettings.speed;
                speedValue.textContent = watermark.motionSettings.speed;
                motionType.value = watermark.motionSettings.motionType;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–≤–∏–∂–µ–Ω–∏—è
                startMotionPreview();
            } else {
                movingWatermark.checked = false;
                motionSettings.classList.remove('active');
                stopMotionPreview();
            }
            
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
            document.querySelectorAll('.saved-watermark-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.saved-watermark-item[data-index="${index}"]`).classList.add('active');
            
            tg.HapticFeedback.impactOccurred('light');
        }
        
        function saveCurrentWatermark() {
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
            const watermarkData = {
                type: watermarkType,
                opacity: opacitySlider.value,
                position: position,
                timestamp: Date.now()
            };
            
            if (watermarkType === 'text') {
                const text = watermarkText.value.trim();
                if (!text) {
                    alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞');
                    return;
                }
                watermarkData.text = text;
                watermarkData.textColor = textColor;
                watermarkData.strokeColor = strokeColor;
            } else {
                if (!watermarkImage) {
                    alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞');
                    return;
                }
                watermarkData.imageData = watermarkImage.src;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ –≤–∫–ª—é—á–µ–Ω—ã
            if (movingWatermark.checked) {
                watermarkData.motionSettings = {
                    moving: true,
                    speed: speedSlider.value,
                    motionType: motionType.value
                };
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö
            savedWatermarks.push(watermarkData);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –≤–æ–¥—è–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤ (–º–∞–∫—Å–∏–º—É–º 10)
            if (savedWatermarks.length > 10) {
                savedWatermarks = savedWatermarks.slice(-10);
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('savedWatermarks', JSON.stringify(savedWatermarks));
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            renderSavedWatermarksList();
            
            tg.HapticFeedback.impactOccurred('medium');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification('–í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
        }
        
        function deleteSavedWatermark(index) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫?')) {
                savedWatermarks.splice(index, 1);
                localStorage.setItem('savedWatermarks', JSON.stringify(savedWatermarks));
                renderSavedWatermarksList();
                tg.HapticFeedback.impactOccurred('light');
            }
        }
        
        function showSaveToGalleryInstruction() {
            instructionModal.classList.remove('hidden');
            tg.HapticFeedback.impactOccurred('light');
        }
        
        function showNotification(message) {
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 1001;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 2000);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
            if (!document.querySelector('#notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        function goToStep(step) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —à–∞–≥–æ–≤
            [step1, step2, step3].forEach(s => s.classList.remove('active', 'completed'));
            [step1Content, step2Content, step3Content].forEach(c => c.classList.remove('active'));
            
            // –û—Ç–º–µ—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —à–∞–≥–∏ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ
            for (let i = 1; i < step; i++) {
                document.getElementById(`step${i}`).classList.add('completed');
            }
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–π —à–∞–≥
            document.getElementById(`step${step}`).classList.add('active');
            document.getElementById(`step${step}Content`).classList.add('active');
            
            currentStep = step;
            
            tg.HapticFeedback.impactOccurred('light');
        }
        
        function setWatermarkType(type) {
            watermarkType = type;
            
            if (type === 'text') {
                textTypeOption.classList.add('active');
                imageTypeOption.classList.remove('active');
                textWatermarkControl.classList.remove('hidden');
                imageWatermarkControl.classList.add('hidden');
            } else {
                textTypeOption.classList.remove('active');
                imageTypeOption.classList.add('active');
                textWatermarkControl.classList.add('hidden');
                imageWatermarkControl.classList.remove('hidden');
            }
        }
        
        function handleMediaUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileType = file.type;
            const reader = new FileReader();
            
            reader.onload = function(e) {
                originalMedia = {
                    file: file,
                    url: e.target.result,
                    type: fileType
                };
                
                originalFormat = fileType;
                originalFileName = file.name;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ñ–∞–π–ª –≤–∏–¥–µ–æ
                isVideo = fileType.startsWith('video/');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                if (isVideo) {
                    mediaPreview.classList.add('hidden');
                    videoContainer.classList.remove('hidden');
                    noPreview.classList.add('hidden');
                    
                    videoPreview.src = e.target.result;
                    videoPreview.load();
                    
                    videoPreview.onloadedmetadata = function() {
                        videoDuration = videoPreview.duration;
                        updateMediaInfo(file, videoDuration);
                        
                        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–π –≤–∏–¥–µ–æ
                        const aspectRatio = videoPreview.videoWidth / videoPreview.videoHeight;
                        const maxWidth = 500;
                        const maxHeight = 400;
                        
                        if (aspectRatio > 1) {
                            // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                            videoContainer.style.width = '100%';
                            videoContainer.style.maxWidth = `${maxWidth}px`;
                        } else {
                            // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                            videoContainer.style.width = 'auto';
                            videoContainer.style.maxWidth = '300px';
                        }
                    };
                } else {
                    videoContainer.classList.add('hidden');
                    mediaPreview.classList.remove('hidden');
                    noPreview.classList.add('hidden');
                    
                    mediaPreview.src = e.target.result;
                    
                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    const img = new Image();
                    img.onload = function() {
                        const aspectRatio = img.width / img.height;
                        if (aspectRatio > 1.5) {
                            mediaPreview.style.maxWidth = '100%';
                            mediaPreview.style.maxHeight = '400px';
                        } else {
                            mediaPreview.style.maxWidth = 'auto';
                            mediaPreview.style.maxHeight = '400px';
                        }
                    };
                    img.src = e.target.result;
                    
                    updateMediaInfo(file);
                }
                
                changeMediaBtn.classList.remove('hidden');
                applyWatermarkBtn.disabled = false;
                
                tg.HapticFeedback.impactOccurred('light');
            };
            
            reader.readAsDataURL(file);
        }
        
        function updateMediaInfo(file, duration = null) {
            const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
            let info = `–§–æ—Ä–º–∞—Ç: ${originalFormat.split('/')[1].toUpperCase()} | –†–∞–∑–º–µ—Ä: ${sizeInMB} –ú–ë`;
            
            if (duration) {
                const minutes = Math.floor(duration / 60);
                const seconds = Math.floor(duration % 60);
                info += ` | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            mediaInfo.textContent = info;
            mediaInfo.classList.remove('hidden');
        }
        
        function handleWatermarkImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                watermarkImage = new Image();
                watermarkImage.src = e.target.result;
                
                watermarkImagePreview.src = e.target.result;
                watermarkImagePreview.classList.remove('hidden');
            };
            
            reader.readAsDataURL(file);
        }
        
        function showProcessing(text) {
            processingText.textContent = text;
            processingOverlay.style.display = 'flex';
        }
        
        function hideProcessing() {
            processingOverlay.style.display = 'none';
        }
        
        async function applyWatermark() {
            if (!originalMedia) return;
            
            showProcessing('–ù–∞–ª–æ–∂–µ–Ω–∏–µ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞...');
            applyWatermarkBtn.disabled = true;
            
            try {
                if (isVideo) {
                    await processVideo();
                } else {
                    await processImage();
                }
                
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∞–≥—É 3
                goToStep(3);
                downloadResultBtn.disabled = false;
                
                tg.HapticFeedback.impactOccurred('medium');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            } finally {
                hideProcessing();
                applyWatermarkBtn.disabled = false;
            }
        }
        
        function processImage() {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫
                    applyWatermarkToCanvas(ctx, canvas.width, canvas.height);
                    
                    let mimeType = originalFormat;
                    if (!mimeType || mimeType === 'image/gif') {
                        mimeType = 'image/png';
                    }
                    
                    try {
                        processedMedia = canvas.toDataURL(mimeType);
                    } catch (e) {
                        processedMedia = canvas.toDataURL('image/png');
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    processedMediaPreview.src = processedMedia;
                    processedMediaPreview.classList.remove('hidden');
                    processedVideoContainer.classList.add('hidden');
                    noProcessedPreview.classList.add('hidden');
                    
                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    const aspectRatio = img.width / img.height;
                    if (aspectRatio > 1.5) {
                        processedMediaPreview.style.maxWidth = '100%';
                        processedMediaPreview.style.maxHeight = '400px';
                    } else {
                        processedMediaPreview.style.maxWidth = 'auto';
                        processedMediaPreview.style.maxHeight = '400px';
                    }
                    
                    resolve();
                };
                
                img.src = originalMedia.url;
            });
        }
        
        function processVideo() {
            return new Promise((resolve) => {
                showProcessing('–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è');
                
                const tempVideo = document.createElement('video');
                tempVideo.src = originalMedia.url;
                tempVideo.muted = true;
                tempVideo.crossOrigin = 'anonymous';
                
                tempVideo.onloadeddata = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = tempVideo.videoWidth;
                    canvas.height = tempVideo.videoHeight;
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
                    initializeWatermarkState(canvas.width, canvas.height);
                    
                    let fps = 30;
                    const totalFrames = Math.floor(videoDuration * fps);
                    let currentFrame = 0;
                    
                    videoFrames = [];
                    
                    function processFrame() {
                        tempVideo.currentTime = currentFrame / fps;
                        
                        tempVideo.onseeked = function() {
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(tempVideo, 0, 0, canvas.width, canvas.height);
                            
                            // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫
                            applyWatermarkToCanvasWithMotion(
                                ctx, 
                                canvas.width, 
                                canvas.height, 
                                currentFrame / totalFrames // –ø—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç 0 –¥–æ 1
                            );
                            
                            videoFrames.push(canvas.toDataURL('image/jpeg', 1.0));
                            currentFrame++;
                            
                            processingText.textContent = `–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ... ${Math.round((currentFrame / totalFrames) * 100)}%`;
                            
                            if (currentFrame < totalFrames) {
                                setTimeout(processFrame, 0);
                            } else {
                                createVideoFromFrames(fps).then(resolve);
                            }
                        };
                    }
                    
                    processFrame();
                };
                
                tempVideo.load();
            });
        }
        
        function initializeWatermarkState(videoWidth, videoHeight) {
            // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
            let watermarkWidth, watermarkHeight;
            
            if (watermarkType === 'text' && watermarkText.value.trim()) {
                // –î–ª—è —Ç–µ–∫—Å—Ç–∞ —Å–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π canvas –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                const fontSize = Math.min(videoWidth, videoHeight) * 0.05;
                
                tempCtx.font = `bold ${fontSize}px Arial`;
                const text = watermarkText.value.trim();
                const textMetrics = tempCtx.measureText(text);
                
                watermarkWidth = textMetrics.width + fontSize;
                watermarkHeight = fontSize * 2;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ
                watermarkState.fontSize = fontSize;
            } else if (watermarkType === 'image' && watermarkImage) {
                watermarkWidth = videoWidth * 0.2;
                watermarkHeight = (watermarkImage.height / watermarkImage.width) * watermarkWidth;
            } else {
                // –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                watermarkWidth = videoWidth * 0.2;
                watermarkHeight = videoHeight * 0.1;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
            watermarkState.width = watermarkWidth;
            watermarkState.height = watermarkHeight;
            watermarkState.videoWidth = videoWidth;
            watermarkState.videoHeight = videoHeight;
            watermarkState.speed = parseInt(speedSlider.value) / 5;
            watermarkState.motionType = motionType.value;
            watermarkState.amplitude = 100;
            watermarkState.frequency = 0.5;
        }
        
        function applyWatermarkToCanvas(ctx, width, height) {
            const opacity = parseInt(opacitySlider.value) / 100;
            
            // –î–ª—è —Å—Ç–∞—Ç–∏—á–Ω–æ–≥–æ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ –≤—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
            let x, y, watermarkWidth, watermarkHeight;
            
            if (watermarkType === 'text' && watermarkText.value.trim()) {
                const fontSize = Math.min(width, height) * 0.05;
                ctx.font = `bold ${fontSize}px Arial`;
                const text = watermarkText.value.trim();
                const textMetrics = ctx.measureText(text);
                
                watermarkWidth = textMetrics.width + fontSize;
                watermarkHeight = fontSize * 2;
                
                switch(position) {
                    case 'top-left':
                        x = 10;
                        y = 10;
                        break;
                    case 'top-center':
                        x = (width - watermarkWidth) / 2;
                        y = 10;
                        break;
                    case 'top-right':
                        x = width - watermarkWidth - 10;
                        y = 10;
                        break;
                    case 'center-left':
                        x = 10;
                        y = (height - watermarkHeight) / 2;
                        break;
                    case 'center':
                        x = (width - watermarkWidth) / 2;
                        y = (height - watermarkHeight) / 2;
                        break;
                    case 'center-right':
                        x = width - watermarkWidth - 10;
                        y = (height - watermarkHeight) / 2;
                        break;
                    case 'bottom-left':
                        x = 10;
                        y = height - watermarkHeight - 10;
                        break;
                    case 'bottom-center':
                        x = (width - watermarkWidth) / 2;
                        y = height - watermarkHeight - 10;
                        break;
                    case 'bottom-right':
                        x = width - watermarkWidth - 10;
                        y = height - watermarkHeight - 10;
                        break;
                }
            } else if (watermarkType === 'image' && watermarkImage) {
                watermarkWidth = width * 0.2;
                watermarkHeight = (watermarkImage.height / watermarkImage.width) * watermarkWidth;
                
                switch(position) {
                    case 'top-left':
                        x = 10;
                        y = 10;
                        break;
                    case 'top-center':
                        x = (width - watermarkWidth) / 2;
                        y = 10;
                        break;
                    case 'top-right':
                        x = width - watermarkWidth - 10;
                        y = 10;
                        break;
                    case 'center-left':
                        x = 10;
                        y = (height - watermarkHeight) / 2;
                        break;
                    case 'center':
                        x = (width - watermarkWidth) / 2;
                        y = (height - watermarkHeight) / 2;
                        break;
                    case 'center-right':
                        x = width - watermarkWidth - 10;
                        y = (height - watermarkHeight) / 2;
                        break;
                    case 'bottom-left':
                        x = 10;
                        y = height - watermarkHeight - 10;
                        break;
                    case 'bottom-center':
                        x = (width - watermarkWidth) / 2;
                        y = height - watermarkHeight - 10;
                        break;
                    case 'bottom-right':
                        x = width - watermarkWidth - 10;
                        y = height - watermarkHeight - 10;
                        break;
                }
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
            ctx.globalAlpha = opacity;
            
            if (watermarkType === 'text' && watermarkText.value.trim()) {
                const text = watermarkText.value.trim();
                const fontSize = Math.min(width, height) * 0.05;
                ctx.font = `bold ${fontSize}px Arial`;
                
                // –†–∏—Å—É–µ–º —Ç–µ–∫—Å—Ç —Å –æ–±–≤–æ–¥–∫–æ–π –∏ –∑–∞–ª–∏–≤–∫–æ–π
                ctx.strokeStyle = strokeColor;
                ctx.fillStyle = textColor;
                ctx.lineWidth = 2;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –¥–ª—è —Ç–µ–∫—Å—Ç–∞
                const centerX = x + (watermarkWidth / 2);
                const centerY = y + (watermarkHeight / 2);
                
                ctx.strokeText(text, centerX, centerY);
                ctx.fillText(text, centerX, centerY);
                
            } else if (watermarkType === 'image' && watermarkImage) {
                // –í–æ–¥—è–Ω–∞—è –º–∞—Ä–∫–∞ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                ctx.drawImage(watermarkImage, x, y, watermarkWidth, watermarkHeight);
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
            ctx.globalAlpha = 1.0;
        }
        
        function applyWatermarkToCanvasWithMotion(ctx, width, height, progress) {
            const opacity = parseInt(opacitySlider.value) / 100;
            
            // –ï—Å–ª–∏ –¥–≤–∏–∂–µ–Ω–∏–µ –Ω–µ –≤–∫–ª—é—á–µ–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç–∏—á–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
            if (!movingWatermark.checked) {
                applyWatermarkToCanvas(ctx, width, height);
                return;
            }
            
            // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤–∏–¥–µ–æ
            const time = progress * 60; // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ "–≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è"
            const pos = calculateMotionPosition(
                time,
                width,
                height,
                watermarkState.width,
                watermarkState.height,
                watermarkState.speed,
                watermarkState.motionType,
                watermarkState.amplitude,
                watermarkState.frequency
            );
            
            let x = Math.max(0, Math.min(width - watermarkState.width, pos.x));
            let y = Math.max(0, Math.min(height - watermarkState.height, pos.y));
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
            ctx.globalAlpha = opacity;
            
            if (watermarkType === 'text' && watermarkText.value.trim()) {
                const text = watermarkText.value.trim();
                
                if (watermarkState.fontSize) {
                    ctx.font = `bold ${watermarkState.fontSize}px Arial`;
                } else {
                    const fontSize = Math.min(width, height) * 0.05;
                    ctx.font = `bold ${fontSize}px Arial`;
                }
                
                // –†–∏—Å—É–µ–º —Ç–µ–∫—Å—Ç —Å –æ–±–≤–æ–¥–∫–æ–π –∏ –∑–∞–ª–∏–≤–∫–æ–π
                ctx.strokeStyle = strokeColor;
                ctx.fillStyle = textColor;
                ctx.lineWidth = 2;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –¥–ª—è —Ç–µ–∫—Å—Ç–∞
                const centerX = x + (watermarkState.width / 2);
                const centerY = y + (watermarkState.height / 2);
                
                ctx.strokeText(text, centerX, centerY);
                ctx.fillText(text, centerX, centerY);
                
            } else if (watermarkType === 'image' && watermarkImage) {
                // –í–æ–¥—è–Ω–∞—è –º–∞—Ä–∫–∞ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                ctx.drawImage(watermarkImage, x, y, watermarkState.width, watermarkState.height);
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
            ctx.globalAlpha = 1.0;
        }
        
        function createVideoFromFrames(fps) {
            return new Promise((resolve) => {
                showProcessing('–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ...');
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = videoPreview.videoWidth;
                canvas.height = videoPreview.videoHeight;
                
                const stream = canvas.captureStream(fps);
                
                let mimeType = 'video/webm;codecs=vp9';
                if (originalFormat.includes('mp4') && MediaRecorder.isTypeSupported('video/mp4;codecs=avc1.42E01E')) {
                    mimeType = 'video/mp4;codecs=avc1.42E01E';
                }
                
                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType,
                    videoBitsPerSecond: 5000000
                });
                
                const chunks = [];
                
                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        chunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = function() {
                    const blob = new Blob(chunks, { 
                        type: mimeType.split(';')[0]
                    });
                    const url = URL.createObjectURL(blob);
                    processedMedia = {
                        url: url,
                        type: mimeType.split(';')[0]
                    };
                    
                    processedVideoPreview.src = url;
                    processedVideoContainer.classList.remove('hidden');
                    processedMediaPreview.classList.add('hidden');
                    noProcessedPreview.classList.add('hidden');
                    
                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ
                    const aspectRatio = videoPreview.videoWidth / videoPreview.videoHeight;
                    const maxWidth = 500;
                    
                    if (aspectRatio > 1) {
                        // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                        processedVideoContainer.style.width = '100%';
                        processedVideoContainer.style.maxWidth = `${maxWidth}px`;
                    } else {
                        // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                        processedVideoContainer.style.width = 'auto';
                        processedVideoContainer.style.maxWidth = '300px';
                    }
                    
                    resolve();
                };
                
                mediaRecorder.start();
                
                let frameIndex = 0;
                const totalFrames = videoFrames.length;
                
                function drawNextFrame() {
                    if (frameIndex >= totalFrames) {
                        mediaRecorder.stop();
                        return;
                    }
                    
                    const img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        frameIndex++;
                        setTimeout(drawNextFrame, 1000 / fps);
                    };
                    
                    img.src = videoFrames[frameIndex];
                }
                
                drawNextFrame();
            });
        }
        
        function downloadResult() {
            if (!processedMedia) return;
            
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const originalName = originalFileName.substring(0, originalFileName.lastIndexOf('.'));
            
            if (isVideo) {
                link.href = processedMedia.url;
                let extension = 'webm';
                if (processedMedia.type === 'video/mp4') {
                    extension = 'mp4';
                }
                link.download = `TgPosted_${originalName}_${timestamp}.${extension}`;
            } else {
                link.href = processedMedia;
                let extension = 'png';
                if (originalFormat.includes('jpeg') || originalFormat.includes('jpg')) {
                    extension = 'jpg';
                } else if (originalFormat.includes('png')) {
                    extension = 'png';
                } else if (originalFormat.includes('gif')) {
                    extension = 'gif';
                }
                link.download = `TgPosted_${originalName}_${timestamp}.${extension}`;
            }
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ—Å–ª–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            setTimeout(() => {
                showSaveToGalleryInstruction();
            }, 500);
            
            tg.HapticFeedback.impactOccurred('medium');
        }
        
        function resetAll() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —à–∞–≥–∏
            currentStep = 1;
            goToStep(1);
            
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
            originalMedia = null;
            processedMedia = null;
            watermarkImage = null;
            videoFrames = [];
            
            // –°–±—Ä–æ—Å UI
            mediaPreview.classList.add('hidden');
            videoContainer.classList.add('hidden');
            noPreview.classList.remove('hidden');
            changeMediaBtn.classList.add('hidden');
            mediaInfo.classList.add('hidden');
            
            processedMediaPreview.classList.add('hidden');
            processedVideoContainer.classList.add('hidden');
            noProcessedPreview.classList.remove('hidden');
            
            watermarkImagePreview.classList.add('hidden');
            watermarkImageInput.value = '';
            fileInput.value = '';
            
            applyWatermarkBtn.disabled = true;
            downloadResultBtn.disabled = true;
            
            // –°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫
            watermarkText.value = '@TgPosted';
            opacitySlider.value = 70;
            opacityValue.textContent = '70%';
            
            // –°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–≤–∏–∂–µ–Ω–∏—è
            movingWatermark.checked = false;
            motionSettings.classList.remove('active');
            speedSlider.value = 5;
            speedValue.textContent = '5';
            motionType.value = 'bounce';
            stopMotionPreview();
            
            // –°–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞ –ø—Ä–µ—Å–µ—Ç–æ–≤ –¥–≤–∏–∂–µ–Ω–∏—è
            document.querySelectorAll('.motion-preset').forEach(p => {
                p.classList.remove('active');
            });
            
            positionButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector('.position-btn[data-position="bottom-right"]').classList.add('active');
            position = 'bottom-right';
            
            // –°–±—Ä–æ—Å —Ü–≤–µ—Ç–æ–≤
            textColor = '#FFFFFF';
            strokeColor = '#000000';
            textColorPicker.value = textColor;
            strokeColorPicker.value = strokeColor;
            updateColorValues();
            highlightPresetByColor(textColor, textColorPresets);
            highlightPresetByColor(strokeColor, strokeColorPresets);
            
            setWatermarkType('text');
            
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –≤–æ–¥—è–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤
            document.querySelectorAll('.saved-watermark-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ
            instructionModal.classList.add('hidden');
            
            tg.HapticFeedback.impactOccurred('light');
        }
    </script>
</body>
</html>
